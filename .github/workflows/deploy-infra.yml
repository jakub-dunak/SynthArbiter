name: Deploy SynthArbiter

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
        default: dev
        description: Environment to deploy
      region:
        type: choice
        options: [us-east-1, us-west-2, eu-west-1, ap-southeast-1]
        default: us-east-1
        description: AWS region for deployment
      skip_parameters:
        type: boolean
        default: false
        description: Skip parameter setup (useful if already done)

jobs:
  setup-parameters:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ${{ inputs.region || 'us-east-1' }}
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
    steps:
      - name: Skip Parameter Setup
        if: ${{ inputs.skip_parameters == true }}
        run: |
          echo "‚è≠Ô∏è Skipping parameter setup as requested"
          exit 0

      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SynthArbiter
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync Parameters to SSM
        if: ${{ inputs.skip_parameters != true }}
        run: |
          echo "üîß Setting up parameters for ${{ env.ENVIRONMENT }} environment..."
          jq -r ".${{ env.ENVIRONMENT }} // empty | to_entries[] | \"\(.key)=\(.value)\"" config/parameters.json | while IFS='=' read -r key value; do
            aws ssm put-parameter \
              --name "/syntharbiter/$key" \
              --value "$value" \
              --type String \
              --overwrite
            echo "‚úì Updated parameter: /syntharbiter/$key"
          done

      - name: Setup Secrets
        if: ${{ inputs.skip_parameters != true }}
        run: |
          echo "üîê Setting up secrets..."
          if ! aws secretsmanager describe-secret --secret-id /syntharbiter/nvidia-ngc-api-key 2>/dev/null; then
            aws secretsmanager create-secret \
              --name /syntharbiter/nvidia-ngc-api-key \
              --secret-string "${{ secrets.NVIDIA_NGC_API_KEY }}"
            echo "‚úì Created NGC API key secret"
          else
            aws secretsmanager update-secret \
              --secret-id /syntharbiter/nvidia-ngc-api-key \
              --secret-string "${{ secrets.NVIDIA_NGC_API_KEY }}"
            echo "‚úì Updated NGC API key secret"
          fi

  deploy-infrastructure:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: setup-parameters
    env:
      AWS_REGION: ${{ inputs.region || 'us-east-1' }}
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SynthArbiter
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation Templates
        run: |
          echo "Validating NIM microservices template..."
          aws cloudformation validate-template --template-body file://cloudformation/04-serverless.yaml || exit 1
          echo "‚úì NIM template validated"

      - name: Package Lambda Functions
        run: |
          # Create Lambda code bucket
          LAMBDA_BUCKET="syntharbiter-${{ env.ENVIRONMENT }}-lambda-code-${{ secrets.AWS_ACCOUNT_ID }}"
          aws s3 mb s3://$LAMBDA_BUCKET --region ${{ env.AWS_REGION }} || echo "Bucket may already exist"

          # Package and upload analyze Lambda
          cd lambda/analyze
          zip -r analyze.zip . -x "*.pyc" "__pycache__/*"
          aws s3 cp analyze.zip s3://$LAMBDA_BUCKET/syntharbiter-${{ env.ENVIRONMENT }}/analyze.zip
          cd ../..

          # Package and upload evaluate Lambda
          cd lambda/evaluate
          zip -r evaluate.zip . -x "*.pyc" "__pycache__/*"
          aws s3 cp evaluate.zip s3://$LAMBDA_BUCKET/syntharbiter-${{ env.ENVIRONMENT }}/evaluate.zip
          cd ../..

          # Package and upload guardrails Lambda
          cd lambda/guardrails
          zip -r guardrails.zip . -x "*.pyc" "__pycache__/*"
          aws s3 cp guardrails.zip s3://$LAMBDA_BUCKET/syntharbiter-${{ env.ENVIRONMENT }}/guardrails.zip
          cd ../..

      - name: Deploy Network Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/01-network.yaml \
            --stack-name syntharbiter-network-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Deploy Storage Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/02-storage.yaml \
            --stack-name syntharbiter-storage-${{ env.ENVIRONMENT }} \
            --parameter-overrides EnvironmentName=${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Deploy Frontend Auth Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/03-frontend-auth.yaml \
            --stack-name syntharbiter-frontend-${{ env.ENVIRONMENT }} \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Deploy NIM Microservices Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/04-serverless.yaml \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --parameter-overrides EnvironmentName=${{ env.ENVIRONMENT }} NetworkStackName=syntharbiter-network-${{ env.ENVIRONMENT }} StorageStackName=syntharbiter-storage-${{ env.ENVIRONMENT }} FrontendStackName=syntharbiter-frontend-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Deploy Static Website
        run: |
          # Get stack outputs from NIM microservices stack
          WEBSITE_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucket`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          API_URL=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiURL`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          AMPLIFY_URL=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteURL`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          # Get Cognito outputs from frontend stack
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-frontend-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-frontend-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          echo "Website Bucket: $WEBSITE_BUCKET"
          echo "API URL: $API_URL"

          # Update config.js
          sed -i "s|your-api-gateway-url|$API_URL|g" app/static/js/config.js
          sed -i "s|your-user-pool-id|$USER_POOL_ID|g" app/static/js/config.js
          sed -i "s|your-user-pool-client-id|$USER_POOL_CLIENT_ID|g" app/static/js/config.js

          # Upload website files to S3
          aws s3 sync app/templates/ s3://$WEBSITE_BUCKET/ --delete --region ${{ env.AWS_REGION }}
          aws s3 sync app/static/ s3://$WEBSITE_BUCKET/ --delete --region ${{ env.AWS_REGION }}

          # Deploy from S3 to Amplify
          AMPLIFY_APP_ID=$(aws cloudformation describe-stacks \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AmplifyAppId`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})

          aws amplify start-deployment \
            --app-id $AMPLIFY_APP_ID \
            --branch-name ${{ env.ENVIRONMENT }} \
            --source-url s3://$WEBSITE_BUCKET/ \
            --source-url-type BUCKET_PREFIX \
            --region ${{ env.AWS_REGION }}

      - name: Output Deployment Info
        run: |
          echo "üéâ SynthArbiter deployment completed successfully!"
          echo ""
          echo "üìä Deployment Summary:"
          echo "üåê Amplify Website URL: $AMPLIFY_URL"
          echo "üîó API Gateway URL: $API_URL"
          echo "ü™£ Website S3 Bucket: $WEBSITE_BUCKET"
          echo "üë§ Cognito User Pool ID: $USER_POOL_ID"
          echo "üîë Cognito Client ID: $USER_POOL_CLIENT_ID"
          echo ""
          echo "üìã Infrastructure Stack Outputs:"
          echo "Network Stack:"
          aws cloudformation describe-stacks \
            --stack-name syntharbiter-network-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs' \
            --output table \
            --region ${{ env.AWS_REGION }} || echo "No outputs"
          echo ""
          echo "Storage Stack:"
          aws cloudformation describe-stacks \
            --stack-name syntharbiter-storage-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs' \
            --output table \
            --region ${{ env.AWS_REGION }} || echo "No outputs"
          echo ""
          echo "Frontend Stack:"
          aws cloudformation describe-stacks \
            --stack-name syntharbiter-frontend-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs' \
            --output table \
            --region ${{ env.AWS_REGION }} || echo "No outputs"
          echo ""
          echo "NIM Microservices Stack:"
          aws cloudformation describe-stacks \
            --stack-name syntharbiter-nim-${{ env.ENVIRONMENT }} \
            --query 'Stacks[0].Outputs' \
            --output table \
            --region ${{ env.AWS_REGION }} || echo "No outputs"


