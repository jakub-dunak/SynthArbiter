name: Deploy Infrastructure

on:
  # push:
  #   branches: [main]
  #   paths: ['cloudformation/**']
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
        default: dev
      region:
        type: choice
        options: [us-east-1, us-west-2, eu-west-1, ap-southeast-1]
        default: us-east-1
        description: AWS region for deployment

jobs:
  deploy-cfn:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ${{ github.event.inputs.region || 'us-east-1' }}
      ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SynthArbiter
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Validate CloudFormation Templates
        run: |
          for template in cloudformation/*.yaml; do
            echo "Validating $template..."
            aws cloudformation validate-template --template-body file://$template || exit 1
          done
          echo "✓ All templates validated"
      
      - name: Deploy Parameters Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/00-parameters.yaml \
            --stack-name syntharbiter-parameters-${{ env.ENVIRONMENT }} \
            --parameter-overrides NGCAPIKey="${{ secrets.NVIDIA_NGC_API_KEY }}" Environment=${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Deploy Network Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/01-network.yaml \
            --stack-name syntharbiter-network-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Deploy IAM Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/02-iam.yaml \
            --stack-name syntharbiter-iam-${{ env.ENVIRONMENT }} \
            --parameter-overrides NEMO_STACK_NAME=syntharbiter-opensearch-${{ env.ENVIRONMENT }} NETWORK_STACK_NAME=syntharbiter-network-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Deploy Storage Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/03-storage.yaml \
            --stack-name syntharbiter-storage-${{ env.ENVIRONMENT }} \
            --parameter-overrides NETWORK_STACK_NAME=syntharbiter-network-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Deploy EKS Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/04-eks.yaml \
            --stack-name syntharbiter-eks-${{ env.ENVIRONMENT }} \
            --parameter-overrides ClusterName=syntharbiter-cluster IAM_STACK_NAME=syntharbiter-iam-${{ env.ENVIRONMENT }} NETWORK_STACK_NAME=syntharbiter-network-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Deploy Application Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/06-application.yaml \
            --stack-name syntharbiter-app-${{ env.ENVIRONMENT }} \
            --no-fail-on-empty-changeset

      - name: Deploy Frontend + Auth Stack (Amplify Manual + Cognito)
        env:
          APP_NAME: syntharbiter-frontend-${{ env.ENVIRONMENT }}
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/06-frontend-auth.yaml \
            --stack-name syntharbiter-frontend-auth-${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              Environment=${{ env.ENVIRONMENT }} \
              AppName="$APP_NAME" \
            --no-fail-on-empty-changeset

      - name: Build and Deploy Frontend to Amplify S3
        run: |
          # Get Amplify app outputs
          AMPLIFY_APP_ID=$(aws cloudformation describe-stacks --stack-name syntharbiter-frontend-auth-${{ env.ENVIRONMENT }} --query 'Stacks[0].Outputs[?OutputKey==`AmplifyAppId`].OutputValue' --output text)
          USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name syntharbiter-frontend-auth-${{ env.ENVIRONMENT }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks --stack-name syntharbiter-frontend-auth-${{ env.ENVIRONMENT }} --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)

          echo "Amplify App ID: $AMPLIFY_APP_ID"
          echo "User Pool ID: $USER_POOL_ID"
          echo "User Pool Client ID: $USER_POOL_CLIENT_ID"

          # Get S3 bucket name from Amplify app
          S3_BUCKET=$(aws amplify get-app --app-id $AMPLIFY_APP_ID --query 'app.deploymentArtifacts' --output text)
          echo "S3 Bucket: $S3_BUCKET"

          # Build frontend
          mkdir -p build
          cp -r app/static/* build/ 2>/dev/null || true
          cp app/templates/index.html build/index.html 2>/dev/null || true

          # Generate config.js with Cognito details
          cat > build/config.js << EOF
          window.COGNITO_CONFIG = {
            region: '${{ env.AWS_REGION }}',
            userPoolId: '$USER_POOL_ID',
            userPoolWebClientId: '$USER_POOL_CLIENT_ID',
            domain: '',
            redirectSignIn: '',
            redirectSignOut: ''
          };
          EOF

          # Upload to S3
          aws s3 sync build/ s3://$S3_BUCKET/ --delete --exact-timestamps

          # Create deployment
          DEPLOYMENT_ID=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name manual --query 'jobId' --output text)
          echo "Deployment ID: $DEPLOYMENT_ID"

          # Start deployment
          aws amplify start-deployment --app-id $AMPLIFY_APP_ID --branch-name manual --job-id $DEPLOYMENT_ID
      
      - name: Output Deployment Info
        run: |
          echo "Deployment completed for environment: ${{ env.ENVIRONMENT }}"
          aws cloudformation describe-stacks --stack-name syntharbiter-eks-${{ env.ENVIRONMENT }} --query 'Stacks[0].Outputs' --output table
      
      - name: Install NVIDIA Device Plugin
        run: |
          kubectl apply -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.14.5/nvidia-device-plugin.yml
          echo "✓ NVIDIA Device Plugin installed"

