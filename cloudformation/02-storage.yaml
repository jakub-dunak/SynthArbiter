AWSTemplateFormatVersion: '2010-09-09'
Description: 'SynthArbiter - Storage Layer'

Parameters:
  NetworkStackName:
    Type: String
    Default: ''
    Description: Name of the network stack to get VPC information from

Resources:
  # S3 Buckets
  DataRawBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-data-raw-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA

  DataCuratedBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-data-curated-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  EmbeddingsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-embeddings-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-logs-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90

  # DynamoDB Table
  AnalysisHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SynthArbiterAnalysisHistory
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: analysisId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: analysisId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true

  # OpenSearch Domain for Vector Search
  OpenSearchDomain:
    Type: AWS::OpenSearchService::Domain
    Properties:
      DomainName: !Sub 'syntharbiter-opensearch-${AWS::AccountId}'
      EngineVersion: OpenSearch_2.11
      ClusterConfig:
        InstanceType: t3.small.search
        InstanceCount: 1
      EBSOptions:
        EBSEnabled: true
        VolumeType: gp3
        VolumeSize: 20
      EncryptionAtRestOptions:
        Enabled: true
      NodeToNodeEncryptionOptions:
        Enabled: true
      DomainEndpointOptions:
        EnforceHTTPS: true
        TLSSecurityPolicy: Policy-Min-TLS-1-2-2019
      AdvancedOptions:
        'override_main_response_version': 'true'
        'knn': 'true'  # Enable k-NN for vector search
      AccessPolicies:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'es:*'
            Resource: !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/syntharbiter-opensearch-${AWS::AccountId}/*'
      VPCOptions:
        SubnetIds: !Split
          - ','
          - Fn::ImportValue: !Sub '${AWS::StackName}-PrivateSubnetIds'
        SecurityGroupIds:
          - !Ref OpenSearchSecurityGroup

  OpenSearchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for OpenSearch domain
      VpcId:
        Fn::ImportValue: !Sub '${NetworkStackName}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16  # VPC CIDR


Outputs:
  DataRawBucketName:
    Description: Raw data bucket name
    Value: !Ref DataRawBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataRawBucket'

  DataCuratedBucketName:
    Description: Curated data bucket name
    Value: !Ref DataCuratedBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataCuratedBucket'

  EmbeddingsBucketName:
    Description: Embeddings bucket name
    Value: !Ref EmbeddingsBucket
    Export:
      Name: !Sub '${AWS::StackName}-EmbeddingsBucket'

  LogsBucketName:
    Description: Logs bucket name
    Value: !Ref LogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-LogsBucket'


  AnalysisHistoryTableName:
    Description: DynamoDB table name
    Value: !Ref AnalysisHistoryTable
    Export:
      Name: !Sub '${AWS::StackName}-AnalysisHistoryTable'

  OpenSearchEndpoint:
    Description: OpenSearch domain endpoint
    Value: !GetAtt OpenSearchDomain.DomainEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-OpenSearchEndpoint'

  OpenSearchARN:
    Description: OpenSearch domain ARN
    Value: !GetAtt OpenSearchDomain.DomainArn
    Export:
      Name: !Sub '${AWS::StackName}-OpenSearchARN'

