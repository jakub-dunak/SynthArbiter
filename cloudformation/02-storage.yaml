AWSTemplateFormatVersion: '2010-09-09'
Description: 'SynthArbiter - Storage Layer'

Resources:
  # S3 Buckets
  DataRawBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-data-raw-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA

  DataCuratedBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-data-curated-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  EmbeddingsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-embeddings-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'syntharbiter-logs-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90

  # DynamoDB Table
  AnalysisHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SynthArbiterAnalysisHistory
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: analysisId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: analysisId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true


Outputs:
  DataRawBucketName:
    Description: Raw data bucket name
    Value: !Ref DataRawBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataRawBucket'

  DataCuratedBucketName:
    Description: Curated data bucket name
    Value: !Ref DataCuratedBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataCuratedBucket'

  EmbeddingsBucketName:
    Description: Embeddings bucket name
    Value: !Ref EmbeddingsBucket
    Export:
      Name: !Sub '${AWS::StackName}-EmbeddingsBucket'

  LogsBucketName:
    Description: Logs bucket name
    Value: !Ref LogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-LogsBucket'


  AnalysisHistoryTableName:
    Description: DynamoDB table name
    Value: !Ref AnalysisHistoryTable
    Export:
      Name: !Sub '${AWS::StackName}-AnalysisHistoryTable'

